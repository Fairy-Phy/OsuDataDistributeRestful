<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Displayer</title>
		<script src="js/Smoother.js"></script>
		<script src="js/rtppd/Formatter.js"></script>
		<style type="text/css">
		body
		{
			background-color:#66CCFF;
		}

		.text
		{
			color:#FFFFFF;
			text-align:center;
			font-size:48px;
			text-shadow:2px 2px 2px #000000;
			font-family:sans-serif;
		}

		.text-hit-count
		{
			font-size:24px;
		}
		</style>
	</head>
	
	<body>
		<pre id="pp-lable" class="text">0.00pp</pre>
		<pre id="hit-count-lable" class="text text-hit-count">0x100 0x50 0xMiss</pre>
		
		<script>
		var html_hit_count=document.querySelector("#hit-count-lable");;
		var html_pp=document.querySelector("#pp-lable");
		
		var _url=new URL(window.location.href);
		var host=_url.searchParams.get('host');
		var port=_url.searchParams.get('port');
		var digits=_url.searchParams.get('digits');
		
		if(host===null)host="localhost";
		if(port===null)port="10800";
		if(digits===null)digits="2";
		
		digits=Number.parseInt(digits);
		
		const st=0.2;
		const dt=0.033;


		var web="http://"+host+":"+port;
		var current_pp=null;
		var target_pp=null;
		
		var hit_count=null;
		
		var smoothers={};
		var pp_formatter=null;
		var hit_count_formatter=null;
		
		var playing=false;
		
		//http get
		function get(uri)
		{
			return new Promise(function(resolve,reject)
			{
				let xhr=new XMLHttpRequest();
				
				xhr.onload=function(e)
				{
					if (xhr.readyState === xhr.DONE) {
						if (xhr.status === 200) {
							resolve(xhr.response);
						}
					}
					reject();
				};
				
				xhr.open("GET",uri,true);
				xhr.responseType="json";
				xhr.send();
			});
		}
		
		//get pp format and hit count format
		get(web+"/api/rtppd/pp/format").then(function(format_json)
		{
			pp_formatter=new Formatter(format_json.Format);
		});
		
		get(web+"/api/rtppd/hit_count/format").then(function(format_json)
		{
			hit_count_formatter=new Formatter(format_json.Format);
		});
		
		//smooth function
		function SmoothObject(previous,target)
		{
			for(let prop in target)
			{
				if(smoothers[prop]===undefined)
					smoothers[prop]=new Smoother(st,dt);
				previous[prop]=smoothers[prop].SmoothDamp(previous[prop],target[prop]);
			}
			return previous;
		}

		//get pp and hit count data
		async function get_data(){
			target_pp = await get(web+"/api/rtppd/pp");
			if(current_pp===null)
				current_pp=target_pp;

			hit_count=await get(web+"/api/rtppd/hit_count");
			
			playing=(await get(web+"/api/rtppd/playing")).Playing;
			
			setTimeout(get_data,150);
		}
		
		//display function
		function display_content()
		{
			if(playing===true)
			{
				if(current_pp!==null)
				{
					current_pp.Data=SmoothObject(current_pp.Data,target_pp.Data);
					if(pp_formatter!=null)
						html_pp.textContent=pp_formatter.Format(current_pp.Data,digits);
				}
				
				if(hit_count!==null)
					if(hit_count_formatter!=null)
						html_hit_count.textContent=hit_count_formatter.Format(hit_count.Data,0);
			}
			else
			{
				html_pp.textContent="";
				html_hit_count.textContent="";
			}
			setTimeout(display_content,33);
		}
		
		get_data();
		display_content();
		</script>
	</body>
</html>