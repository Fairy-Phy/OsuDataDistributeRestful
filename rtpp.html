<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Displayer</title>
	<script src="js/ODDR.js"></script>
	<script src="js/rtppd/RTPPD.js"></script>
	<script src="js/ORTDP.js"></script>
	<script src="js/Smoother.js"></script>
	<script src="js/rtppd/Formatter.js"></script>
	<style type="text/css">
		body {
			background-color: #66CCFF;
		}

		.text {
			color: #FFFFFF;
			text-align: center;
			font-size: 48px;
			text-shadow: 2px 2px 2px #000000;
			font-family: sans-serif;
		}

		.text-hit-count {
			font-size: 24px;
		}
	</style>
</head>

<body>
	<pre id="pp-lable" class="text">0.00pp</pre>
	<pre id="hit-count-lable" class="text text-hit-count">0x100 0x50 0xMiss</pre>

	<script>
		window.onerror = function (message, source, lineno, colno, error) {
			const regex = /(\w) is not defined/;
			console.log(message)
			if (regex.test(message)) {
				let v = regex.exec(message)[1];
				window[v] = 0;
			}
		};
		(async function () {
			let html_hit_count = document.querySelector("#hit-count-lable");
			let html_pp = document.querySelector("#pp-lable");

			let _url = new URL(window.location.href);
			let host = _url.searchParams.get('host');
			let port = _url.searchParams.get('port');
			let digits = _url.searchParams.get('digits');

			if (host === null) host = "localhost";
			if (port === null) port = "10800";
			if (digits === null) digits = "2";

			digits = Number.parseInt(digits);

			const st = 0.2;
			const fps = 30;
			const dt = 1.0 / fps;;
			const render_interval = dt * 1000;
			const get_interval = 200;

			let current_pp = null;
			let target_pp = null;

			let hit_count = null;
			let beatmapTuple = null;

			let smoothers = {};
			let pp_formatter = null;
			let hit_count_formatter = null;

			//initialize ODDR and RTPPD
			let oddr = new ODDR(host, port);
			let rtppd = new RTPPD(oddr);
			let ortdp = new ORTDP(oddr);

			//get pp format and hit count format
			rtppd.getPerformancePointFormatString().then(function (format_json) {
				pp_formatter = new Formatter(format_json.format,digits);
			});

			rtppd.getHitCountFormatString().then(function (format_json) {
				hit_count_formatter = new Formatter(format_json.format,0);
			});

			//smooth function
			function SmoothObject(previous, target) {
				for (let prop in target) {
					if (smoothers[prop] === undefined)
						smoothers[prop] = new Smoother(st, dt);
					previous[prop] = smoothers[prop].SmoothDamp(previous[prop], target[prop]);
				}
				return previous;
			}

			//display function
			async function display_content() {
				target_pp = await rtppd.getPerformancePointAt(0);
				if (current_pp === null)
					current_pp = target_pp;

				hit_count = await rtppd.getHitCountAt(0);
				beatmapTuple = await rtppd.getBeatmapTupleAt(0);
				beatmapTuple.time = await ortdp.getPlayingTime();
				const status = (await ortdp.getGameStatusAt()).status;

				if (status == ortdp.STATUS_PLAYING) {
					let tuple = Object.assign(current_pp, hit_count);
					tuple = Object.assign(tuple, beatmapTuple);

					if (current_pp !== null) {
						current_pp = SmoothObject(current_pp, target_pp);
						if (pp_formatter != null)
							html_pp.textContent = pp_formatter.Format(tuple);
					}

					if (hit_count !== null)
						if (hit_count_formatter != null)
							html_hit_count.textContent = hit_count_formatter.Format(tuple);
				}

				if(status != ortdp.STATUS_RANK && status != ortdp.STATUS_PLAYING){
					html_pp.textContent = "";
					html_hit_count.textContent = "";
					if(pp_formatter!=null)
						pp_formatter.resetVariable();
					if(hit_count_formatter!=null)
						hit_count_formatter.resetVariable();
				}
				setTimeout(display_content, render_interval);
			}

			display_content();
		})();
	</script>
</body>

</html>