<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Visualizer</title>
    <style>
        #thefile {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 100;
        }

        #canvas {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }

        audio {
            position: fixed;
            left: 10px;
            bottom: 10px;
            width: calc(100% - 20px);
        }
    </style>
    
    <script>
        const MAX_HEIGTH=190;
        var context = new AudioContext();
        var play=false;
		
		var _url=new URL(window.location.href);
		var has_sound=_url.searchParams.get('sound')||"false";

        var current_audio_buffer=null;
        var src = context.createBufferSource();
        var analyser = context.createAnalyser();
        analyser.smoothingTimeConstant=0.6;
        src.connect(analyser);

        //链接音频输出设备
		if(has_sound==="true")
			analyser.connect(context.destination);

        //http get
        function get(uri,type){
            return new Promise(function(resolve,reject)
            {
                let xhr=new XMLHttpRequest();
                
                xhr.onload=function(e)
                {
                    if (xhr.readyState === xhr.DONE) {
                        if (xhr.status === 200) {
                            resolve(xhr.response);
                        }
                    }
                    else 
                        reject();
                };
                xhr.open("GET",uri,true);
                xhr.responseType=type||"json";
                xhr.send();
            });
        }

        var last_mods={time_rate:1.0};
        var last_mp3="";
        var audio_url=null;
        var timer=0;

        //play and seek andio
        function restart_audio(buf,time,time_rate)
        {
            if(buf===null)return;
            if(time<0)return;
            src.disconnect(analyser);
            
            src=context.createBufferSource();
            src.buffer=buf;
            src.playbackRate.value=last_mods.time_rate;
            src.connect(analyser);

            src.start(0,time);
            timer=time;
            play=true;
        }

        //play timer
        setInterval(function(){
            if(play===true)
                timer+=0.026*last_mods.time_rate;
        },Math.round(26*last_mods.time_rate));
        
        //http get loop
        async function get_loop()
        {
            let time=(await get('http://localhost:10800/api/ortdp/playing_time')).playing_time/1000.0;
            let beatmap=await get('http://localhost:10800/api/ortdp/beatmap');
            let mods=await get('http://localhost:10800/api/ortdp/mods');

            let folder=beatmap.folder;
            let mp3=beatmap.audio_filename;
			mp3=folder+'\\'+mp3;

            if(folder!==""&&mp3!=="")
            {
                if(last_mp3!=mp3)
                {   
                    if(play===true)
                    {
                        src.stop(0);
                        play=false;
                    }

                    let audio_data=await get('http://localhost:10800/api/ortdp/audio_file',"arraybuffer");
                    let buf=await context.decodeAudioData(audio_data);
                    current_audio_buffer=buf;
                    restart_audio(buf,time,1.0);
                }
            }
            if(Math.abs(timer-time)>0.7)
                restart_audio(current_audio_buffer,time,mods.time_rate);
            
            if(last_mods.time_rate!=mods.time_rate)
                restart_audio(current_audio_buffer,time,mods.time_rate);

            last_mp3=mp3;
            last_mods=mods;
            setTimeout(get_loop,100);
        }

        //canvas initialize
        async function play_audio() {
            var canvas = document.getElementById("canvas");
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            var ctx = canvas.getContext("2d");

            analyser.fftSize = 512;

            var bufferLength = analyser.frequencyBinCount;
            console.log(bufferLength);

            var dataArray = new Uint8Array(bufferLength);
                
            var WIDTH = canvas.width;
            var HEIGHT = canvas.height;

            var barWidth = (WIDTH / bufferLength) * 2.5;
            var barHeight;
            var x = 0;

            //render
            function renderFrame() {
                requestAnimationFrame(renderFrame);

                x = 0;

                analyser.getByteFrequencyData(dataArray);

                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, WIDTH, HEIGHT);

                for (let i = 0; i < bufferLength; i++) {
                    let val=dataArray[i]/255.0;
                    barHeight = val*val*val;
                    
                    let r = 128+Math.round((128*(i/bufferLength)));
                    let g = Math.round(barHeight*230-(25 * (i/bufferLength)));
                    let b = 203;

                    ctx.fillStyle = "rgb(" + r + "," + g + "," + b + ")";

                    //target heigth
                    barHeight=Math.round(barHeight*MAX_HEIGTH);

                    ctx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);

                    x += barWidth + 1;
                }
            }
            renderFrame();
        };

        window.onload=function(){
            get_loop();
            play_audio();
        }
    </script>
</head>

<body>
    <div id="content">
        <canvas id="canvas"></canvas>
    </div>
</body>
</html>

